<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rent Property Manager - Akahu Integration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .section {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .property-list {
            margin-top: 20px;
        }

        .property-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }

        .property-item h4 {
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .property-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 14px;
        }

        .status {
            padding: 10px;
            margin: 20px 0;
            border-radius: 4px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .nav-tabs {
            display: flex;
            background: #ecf0f1;
            border-bottom: 1px solid #bdc3c7;
            margin: 0;
            padding: 0;
        }

        .nav-tab {
            background: #ecf0f1;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-size: 16px;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            background: #d5dbdb;
        }

        .nav-tab.active {
            background: white;
            border-bottom-color: #3498db;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .rent-check-item {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .rent-check-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rent-check-header:hover {
            background: #e9ecef;
        }

        .check-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .check-status.completed {
            background: #d4edda;
            color: #155724;
        }

        .check-status.running {
            background: #fff3cd;
            color: #856404;
        }

        .check-status.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .rent-check-details {
            display: none;
            padding: 20px;
            background: white;
        }

        .rent-check-details.expanded {
            display: block;
        }

        .step-list {
            list-style: none;
            padding: 0;
        }

        .step-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .step-item:last-child {
            border-bottom: none;
        }

        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .step-icon.completed {
            background: #28a745;
            color: white;
        }

        .step-icon.running {
            background: #ffc107;
            color: #212529;
        }

        .step-icon.failed {
            background: #dc3545;
            color: white;
        }

        .step-icon.pending {
            background: #6c757d;
            color: white;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .step-details {
            color: #666;
            font-size: 14px;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .rent-check-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-number {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .summary-label {
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Rent Property Manager</h1>
            <p>Integrate with Akahu Bank Feed & Manage Properties</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('properties')">Properties</button>
            <button class="nav-tab" onclick="switchTab('rent-checks')">Rent Checks</button>
        </div>

        <div id="properties-tab" class="tab-content active">
            <div class="section">
                <h2>Akahu Integration Settings</h2>
            <form id="akahuForm">
                <div class="form-group">
                    <label for="akahuAppToken">Akahu App Token:</label>
                    <input type="password" id="akahuAppToken" name="akahuAppToken" required>
                </div>
                <div class="form-group">
                    <label for="akahuUserToken">Akahu User Token:</label>
                    <input type="password" id="akahuUserToken" name="akahuUserToken" required>
                </div>
                <button type="submit" class="btn">Save Akahu Settings</button>
                <button type="button" class="btn" onclick="testConnection()">Test Connection</button>
            </form>
            <div id="akahuStatus" class="status"></div>
        </div>

        <div class="section">
            <h2>Email Notification Settings</h2>
            <div style="background: #e8f4fd; padding: 15px; margin-bottom: 20px; border-radius: 4px; border-left: 4px solid #007bff;">
                <h4 style="margin-top: 0; color: #0056b3;">üìß Gmail App Password Setup Guide:</h4>
                <ol style="margin: 8px 0; padding-left: 20px;">
                    <li><strong>Enable 2-Factor Authentication</strong> on your Google Account</li>
                    <li>Go to <strong>Google Account Settings ‚Üí Security ‚Üí App Passwords</strong></li>
                    <li><strong>Generate App Password</strong> for "Mail" application</li>
                    <li><strong>Use the 16-character App Password</strong> (not your regular Gmail password)</li>
                    <li><strong>Format:</strong> abcd efgh ijkl mnop (remove spaces when entering)</li>
                </ol>
                <p style="margin: 8px 0; color: #d9534f;"><strong>‚ö†Ô∏è Common Issue:</strong> Make sure 2FA is enabled FIRST, then generate App Password</p>
            </div>
            <form id="emailForm">
                <div class="form-group">
                    <label for="notificationEmail">Your Email Address:</label>
                    <input type="email" id="notificationEmail" name="notificationEmail" required>
                    <small style="color: #666; font-size: 12px;">‚ö†Ô∏è For testing: Use a different email than your sender email to avoid spam filtering</small>
                </div>
                <div class="form-group">
                    <label for="emailProvider">Email Service:</label>
                    <select id="emailProvider" name="emailProvider" required>
                        <option value="">Select email service</option>
                        <option value="gmail">Gmail</option>
                        <option value="outlook">Outlook/Hotmail</option>
                        <option value="smtp">Custom SMTP</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="senderEmail">Sender Email:</label>
                    <input type="email" id="senderEmail" name="senderEmail" required>
                </div>
                <div class="form-group">
                    <label for="senderPassword">Sender Email Password/App Password:</label>
                    <input type="password" id="senderPassword" name="senderPassword" required>
                    <div id="passwordInstructions" style="margin-top: 8px; padding: 10px; background: #f0f8ff; border-left: 3px solid #007bff; border-radius: 4px; display: none;">
                        <strong>üìß Gmail Setup Instructions:</strong><br>
                        1. Enable 2-Factor Authentication on your Google account<br>
                        2. Go to Google Account Settings ‚Üí Security ‚Üí App Passwords<br>
                        3. Generate a new App Password for "Mail"<br>
                        4. Use the 16-character App Password here (not your regular password)<br>
                        5. Example: abcd efgh ijkl mnop
                    </div>
                    <div id="outlookInstructions" style="margin-top: 8px; padding: 10px; background: #f0f8ff; border-left: 3px solid #007bff; border-radius: 4px; display: none;">
                        <strong>üìß Outlook Setup Instructions:</strong><br>
                        1. Use your full Outlook/Hotmail email address<br>
                        2. Use your regular Microsoft account password<br>
                        3. If you have 2FA enabled, use an App Password instead
                    </div>
                </div>
                <div id="smtpSettings" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="smtpHost">SMTP Host:</label>
                            <input type="text" id="smtpHost" name="smtpHost">
                        </div>
                        <div class="form-group">
                            <label for="smtpPort">SMTP Port:</label>
                            <input type="number" id="smtpPort" name="smtpPort">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableAutoEmail" name="enableAutoEmail">
                        Enable automatic email notifications for rent checks
                    </label>
                </div>
                <button type="submit" class="btn btn-success">Save Email Settings</button>
                <button type="button" class="btn" onclick="checkEmailConfig()">Check Configuration</button>
                <button type="button" class="btn" onclick="testEmail()">Send Test Email</button>
            </form>
            <div id="emailStatus" class="status"></div>
        </div>

        <div class="section">
            <h2>Add Property</h2>
            <form id="propertyForm">
                <div class="form-group">
                    <label for="propertyAddress">Property Address:</label>
                    <input type="text" id="propertyAddress" name="propertyAddress" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="rentAmount">Rent Amount ($):</label>
                        <input type="number" id="rentAmount" name="rentAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="rentFrequency">Rent Frequency:</label>
                        <select id="rentFrequency" name="rentFrequency" required>
                            <option value="">Select frequency</option>
                            <option value="weekly">Weekly</option>
                            <option value="fortnightly">Fortnightly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="tenantName">Tenant Name:</label>
                        <input type="text" id="tenantName" name="tenantName" required>
                    </div>
                    <div class="form-group">
                        <label for="rentDueDay">Rent Due Day:</label>
                        <input type="number" id="rentDueDay" name="rentDueDay" min="1" max="31" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="transactionKeyword">Transaction Keyword (for bank feed matching):</label>
                    <input type="text" id="transactionKeyword" name="transactionKeyword"
                           placeholder="e.g., tenant name, property reference, etc." required>
                </div>

                <button type="submit" class="btn btn-success">Add Property</button>
            </form>
            <div id="propertyStatus" class="status"></div>
        </div>

        <div class="section">
            <h2>Your Properties</h2>
            <div id="propertyList" class="property-list">
                <p>No properties added yet.</p>
            </div>
            <button type="button" class="btn" onclick="fetchBankTransactions()">Fetch Bank Transactions</button>
            <button type="button" class="btn btn-warning" onclick="runRentCheck(true)">Run Rent Check Now</button>
            </div>
        </div>

        <div id="rent-checks-tab" class="tab-content">
            <div class="section">
                <h2>Rent Check History</h2>
                <div class="rent-check-summary">
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-number" id="totalChecks">0</div>
                            <div class="summary-label">Total Checks</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number" id="successfulChecks">0</div>
                            <div class="summary-label">Successful</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number" id="failedChecks">0</div>
                            <div class="summary-label">Failed</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-number" id="nextCheck">-</div>
                            <div class="summary-label">Next Check</div>
                        </div>
                    </div>
                </div>
                <div id="rentCheckHistory">
                    <p>No rent checks have been run yet.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let properties = JSON.parse(localStorage.getItem('properties') || '[]');
        let akahuSettings = JSON.parse(localStorage.getItem('akahuSettings') || '{}');
        let rentChecks = JSON.parse(localStorage.getItem('rentChecks') || '[]');
        let emailSettings = JSON.parse(localStorage.getItem('emailSettings') || '{}');
        let checkInterval;

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');

            if (tabName === 'rent-checks') {
                updateRentCheckSummary();
                displayRentChecks();
            }
        }

        document.getElementById('akahuForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const settings = {
                appToken: formData.get('akahuAppToken'),
                userToken: formData.get('akahuUserToken')
            };

            localStorage.setItem('akahuSettings', JSON.stringify(settings));
            akahuSettings = settings;

            showStatus('akahuStatus', 'Akahu settings saved successfully!', 'success');
        });

        document.getElementById('emailForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const settings = {
                notificationEmail: formData.get('notificationEmail'),
                emailProvider: formData.get('emailProvider'),
                senderEmail: formData.get('senderEmail'),
                senderPassword: formData.get('senderPassword'),
                smtpHost: formData.get('smtpHost'),
                smtpPort: formData.get('smtpPort'),
                enableAutoEmail: formData.get('enableAutoEmail') === 'on'
            };

            localStorage.setItem('emailSettings', JSON.stringify(settings));
            emailSettings = settings;

            showStatus('emailStatus', 'Email settings saved successfully!', 'success');
        });

        document.getElementById('emailProvider').addEventListener('change', function() {
            const smtpSettings = document.getElementById('smtpSettings');
            const smtpHost = document.getElementById('smtpHost');
            const smtpPort = document.getElementById('smtpPort');
            const passwordInstructions = document.getElementById('passwordInstructions');
            const outlookInstructions = document.getElementById('outlookInstructions');

            // Hide all instructions first
            passwordInstructions.style.display = 'none';
            outlookInstructions.style.display = 'none';

            if (this.value === 'smtp') {
                smtpSettings.style.display = 'block';
                smtpHost.required = true;
                smtpPort.required = true;
            } else {
                smtpSettings.style.display = 'none';
                smtpHost.required = false;
                smtpPort.required = false;

                // Set default SMTP settings and show instructions
                if (this.value === 'gmail') {
                    smtpHost.value = 'smtp.gmail.com';
                    smtpPort.value = '587';
                    passwordInstructions.style.display = 'block';
                } else if (this.value === 'outlook') {
                    smtpHost.value = 'smtp-mail.outlook.com';
                    smtpPort.value = '587';
                    outlookInstructions.style.display = 'block';
                }
            }
        });

        document.getElementById('propertyForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const property = {
                id: Date.now(),
                address: formData.get('propertyAddress'),
                rentAmount: parseFloat(formData.get('rentAmount')),
                rentFrequency: formData.get('rentFrequency'),
                tenantName: formData.get('tenantName'),
                rentDueDay: parseInt(formData.get('rentDueDay')),
                transactionKeyword: formData.get('transactionKeyword')
            };

            properties.push(property);
            localStorage.setItem('properties', JSON.stringify(properties));

            this.reset();
            displayProperties();
            updateNextCheckDate();
            showStatus('propertyStatus', 'Property added successfully!', 'success');
        });

        function displayProperties() {
            const listElement = document.getElementById('propertyList');

            if (properties.length === 0) {
                listElement.innerHTML = '<p>No properties added yet.</p>';
                return;
            }

            listElement.innerHTML = properties.map(property => `
                <div class="property-item">
                    <h4>${property.address}</h4>
                    <div class="property-details">
                        <div><strong>Tenant:</strong> ${property.tenantName}</div>
                        <div><strong>Rent:</strong> $${property.rentAmount} ${property.rentFrequency}</div>
                        <div><strong>Due Day:</strong> ${property.rentDueDay}</div>
                        <div><strong>Keyword:</strong> ${property.transactionKeyword}</div>
                    </div>
                </div>
            `).join('');
        }

        function showStatus(elementId, message, type) {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';

            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        async function testConnection() {
            if (!akahuSettings.appToken || !akahuSettings.userToken) {
                showStatus('akahuStatus', 'Please save Akahu settings first', 'error');
                return;
            }

            showStatus('akahuStatus', 'Testing connection to Akahu API...', 'success');

            try {
                const response = await makeAkahuRequest('/me');
                if (response.success) {
                    showStatus('akahuStatus', `Connection successful! User: ${response.item.name}`, 'success');
                } else {
                    showStatus('akahuStatus', 'Connection failed: ' + response.message, 'error');
                }
            } catch (error) {
                showStatus('akahuStatus', 'Connection failed: ' + error.message, 'error');
            }
        }

        async function makeAkahuRequest(endpoint, method = 'GET', body = null) {
            const headers = {
                'Authorization': `Bearer ${akahuSettings.userToken}`,
                'X-Akahu-ID': akahuSettings.appToken,
                'Content-Type': 'application/json'
            };

            const options = {
                method,
                headers,
                mode: 'cors'
            };

            if (body && method !== 'GET') {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`/api/akahu${endpoint}`, options);
                const data = await response.json();

                return {
                    success: response.ok,
                    status: response.status,
                    message: data.message || (response.ok ? 'Success' : 'Request failed'),
                    item: data.item,
                    items: data.items,
                    cursor: data.cursor
                };
            } catch (error) {
                return {
                    success: false,
                    message: error.message,
                    item: null,
                    items: []
                };
            }
        }

        async function fetchBankTransactions() {
            if (!akahuSettings.appToken || !akahuSettings.userToken) {
                alert('Please configure Akahu settings with both App Token and User Token');
                return;
            }

            if (properties.length === 0) {
                alert('Please add at least one property first');
                return;
            }

            try {
                // Get accounts first
                const accountsResponse = await makeAkahuRequest('/accounts');
                if (!accountsResponse.success) {
                    alert('Failed to fetch accounts: ' + accountsResponse.message);
                    return;
                }

                // Get transactions for all accounts
                const allTransactions = [];
                for (const account of accountsResponse.items) {
                    const transactionsResponse = await makeAkahuRequest(`/accounts/${account._id}/transactions?start=${getDateDaysAgo(30)}`);
                    if (transactionsResponse.success) {
                        allTransactions.push(...transactionsResponse.items);
                    }
                }

                // Match transactions to properties
                const matchedTransactions = matchTransactionsToProperties(allTransactions);
                displayTransactionResults(matchedTransactions);

            } catch (error) {
                alert('Error fetching transactions: ' + error.message);
            }
        }

        function getDateDaysAgo(days) {
            const date = new Date();
            date.setDate(date.getDate() - days);
            return date.toISOString().split('T')[0];
        }

        function matchTransactionsToProperties(transactions) {
            const matches = [];

            properties.forEach(property => {
                const propertyMatches = transactions.filter(transaction => {
                    const description = (transaction.description || '').toLowerCase();
                    const keyword = property.transactionKeyword.toLowerCase();

                    // Check if transaction is a credit (incoming payment)
                    const isCredit = transaction.amount > 0;

                    // Check if description contains the keyword
                    const keywordMatch = description.includes(keyword);

                    // Check if amount matches rent (within 5% tolerance)
                    const amountMatch = Math.abs(transaction.amount - property.rentAmount) <= (property.rentAmount * 0.05);

                    return isCredit && keywordMatch && amountMatch;
                });

                matches.push({
                    property,
                    transactions: propertyMatches
                });
            });

            return matches;
        }

        function displayTransactionResults(matchedTransactions) {
            let resultHtml = '<h3>Recent Rent Payments</h3>';

            matchedTransactions.forEach(match => {
                resultHtml += `<div class="property-item">
                    <h4>${match.property.address}</h4>
                    <p><strong>Expected:</strong> $${match.property.rentAmount} ${match.property.rentFrequency}</p>
                    <p><strong>Keyword:</strong> ${match.property.transactionKeyword}</p>

                    ${match.transactions.length > 0 ?
                        '<h5>Matched Transactions:</h5>' +
                        match.transactions.map(tx => `
                            <div style="margin-left: 20px; padding: 10px; background: #f0f8ff; border-left: 3px solid #007bff; margin-bottom: 10px;">
                                <strong>$${tx.amount}</strong> - ${new Date(tx.date).toLocaleDateString()}<br>
                                <small>${tx.description}</small><br>
                                <small>Account: ${tx.account}</small>
                            </div>
                        `).join('')
                        :
                        '<p style="color: #dc3545; font-style: italic;">No matching transactions found</p>'
                    }
                </div>`;
            });

            // Create a modal or new section to show results
            const existingResults = document.getElementById('transactionResults');
            if (existingResults) {
                existingResults.innerHTML = resultHtml;
            } else {
                const resultsDiv = document.createElement('div');
                resultsDiv.id = 'transactionResults';
                resultsDiv.innerHTML = `<div class="section">${resultHtml}</div>`;
                document.querySelector('.container').appendChild(resultsDiv);
            }
        }

        function getNextRentDueDate(property) {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const currentDay = now.getDate();

            let dueDate;

            if (property.rentFrequency === 'monthly') {
                dueDate = new Date(currentYear, currentMonth, property.rentDueDay);
                if (dueDate <= now) {
                    dueDate = new Date(currentYear, currentMonth + 1, property.rentDueDay);
                }
            } else if (property.rentFrequency === 'weekly') {
                const daysSinceLastDue = (currentDay - property.rentDueDay + 7) % 7;
                dueDate = new Date(now);
                dueDate.setDate(currentDay - daysSinceLastDue + 7);
            } else if (property.rentFrequency === 'fortnightly') {
                const daysSinceLastDue = (currentDay - property.rentDueDay + 14) % 14;
                dueDate = new Date(now);
                dueDate.setDate(currentDay - daysSinceLastDue + 14);
            }

            return dueDate;
        }

        function getLastRentDueDate(property) {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const currentDay = now.getDate();

            let lastDueDate;

            if (property.rentFrequency === 'monthly') {
                lastDueDate = new Date(currentYear, currentMonth, property.rentDueDay);
                if (lastDueDate > now) {
                    lastDueDate = new Date(currentYear, currentMonth - 1, property.rentDueDay);
                }
            } else if (property.rentFrequency === 'weekly') {
                const daysSinceLastDue = (currentDay - property.rentDueDay + 7) % 7;
                lastDueDate = new Date(now);
                lastDueDate.setDate(currentDay - daysSinceLastDue);
                if (daysSinceLastDue === 0 && now.getHours() < 12) {
                    lastDueDate.setDate(lastDueDate.getDate() - 7);
                }
            } else if (property.rentFrequency === 'fortnightly') {
                const daysSinceLastDue = (currentDay - property.rentDueDay + 14) % 14;
                lastDueDate = new Date(now);
                lastDueDate.setDate(currentDay - daysSinceLastDue);
                if (daysSinceLastDue === 0 && now.getHours() < 12) {
                    lastDueDate.setDate(lastDueDate.getDate() - 14);
                }
            }

            return lastDueDate;
        }

        function analyzePaymentTiming(transactionDate, dueDate) {
            const transDate = new Date(transactionDate);
            const due = new Date(dueDate);
            const diffDays = Math.floor((transDate - due) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                return { status: 'on-time', description: 'Received on due date', daysDiff: 0 };
            } else if (diffDays < 0) {
                return { status: 'early', description: `Received ${Math.abs(diffDays)} day(s) early`, daysDiff: diffDays };
            } else {
                return { status: 'late', description: `Received ${diffDays} day(s) late`, daysDiff: diffDays };
            }
        }

        function getNextCheckDate() {
            if (properties.length === 0) return null;

            const nextDueDates = properties.map(property => {
                const dueDate = getNextRentDueDate(property);
                const checkDate = new Date(dueDate);
                checkDate.setDate(checkDate.getDate() + 1);
                return checkDate;
            });

            return new Date(Math.min(...nextDueDates));
        }

        function updateNextCheckDate() {
            const nextCheck = getNextCheckDate();
            const nextCheckElement = document.getElementById('nextCheck');
            if (nextCheckElement) {
                nextCheckElement.textContent = nextCheck ?
                    nextCheck.toLocaleDateString() : '-';
            }
        }

        function shouldRunRentCheck() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            const propertiesNeedingCheck = properties.filter(property => {
                const lastDueDate = getLastRentDueDate(property);
                const dueDateOnly = new Date(lastDueDate.getFullYear(), lastDueDate.getMonth(), lastDueDate.getDate());

                // Check if today is the due date or up to 2 days after due date
                const daysSinceDue = Math.floor((today - dueDateOnly) / (1000 * 60 * 60 * 24));
                const shouldCheckToday = daysSinceDue >= 0 && daysSinceDue <= 2;

                if (!shouldCheckToday) return false;

                const lastCheck = rentChecks
                    .filter(check => check.propertyId === property.id)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];

                // If no previous check, run it
                if (!lastCheck) return true;

                // Only run if we haven't checked for this due date yet
                const lastCheckDate = new Date(lastCheck.timestamp);
                const lastCheckDateOnly = new Date(lastCheckDate.getFullYear(), lastCheckDate.getMonth(), lastCheckDate.getDate());

                // Don't run multiple checks on the same day for the same property
                return lastCheckDateOnly < today;
            });

            return propertiesNeedingCheck;
        }

        function runRentCheck(manual = false) {
            if (!akahuSettings.appToken || !akahuSettings.userToken) {
                alert('Please configure Akahu settings with both App Token and User Token before running rent checks');
                return;
            }

            if (properties.length === 0) {
                alert('Please add at least one property before running rent checks');
                return;
            }

            const propertiesToCheck = manual ? properties : shouldRunRentCheck();

            if (propertiesToCheck.length === 0) {
                if (manual) {
                    alert('No properties available for checking.');
                } else {
                    console.log('No properties need automatic checking at this time.');
                }
                return;
            }

            if (manual) {
                alert(`Starting manual rent check for ${propertiesToCheck.length} property(ies). Switch to the Rent Checks tab to watch the progress.`);
                // Switch to rent checks tab automatically
                switchTab('rent-checks');
            }

            propertiesToCheck.forEach(property => {
                executeRentCheck(property, manual);
            });
        }

        async function executeRentCheck(property, manual = false) {
            const checkId = Date.now() + Math.random();
            const lastDueDate = getLastRentDueDate(property);
            const nextDueDate = getNextRentDueDate(property);

            const rentCheck = {
                id: checkId,
                propertyId: property.id,
                propertyAddress: property.address,
                tenantName: property.tenantName,
                timestamp: new Date().toISOString(),
                status: 'running',
                manual: manual,
                lastDueDate: lastDueDate.toISOString(),
                nextDueDate: nextDueDate.toISOString(),
                expectedAmount: property.rentAmount,
                rentFrequency: property.rentFrequency,
                steps: [
                    { id: 1, title: 'Connecting to Akahu API', status: 'pending', details: '', timestamp: null },
                    { id: 2, title: 'Fetching accounts', status: 'pending', details: '', timestamp: null },
                    { id: 3, title: 'Fetching recent transactions', status: 'pending', details: '', timestamp: null },
                    { id: 4, title: `Searching for keyword: "${property.transactionKeyword}"`, status: 'pending', details: '', timestamp: null },
                    { id: 5, title: 'Analyzing payment amounts', status: 'pending', details: '', timestamp: null },
                    { id: 6, title: 'Generating report', status: 'pending', details: '', timestamp: null }
                ],
                result: null
            };

            rentChecks.unshift(rentCheck);
            localStorage.setItem('rentChecks', JSON.stringify(rentChecks));

            if (document.getElementById('rent-checks-tab').classList.contains('active')) {
                displayRentChecks();
                updateRentCheckSummary();
            }

            await performActualRentCheck(checkId, property);
        }

        async function performActualRentCheck(checkId, property) {
            const updateStep = (stepIndex, status, details = '') => {
                const check = rentChecks.find(c => c.id === checkId);
                if (!check) return;

                check.steps[stepIndex].status = status;
                check.steps[stepIndex].details = details;
                check.steps[stepIndex].timestamp = new Date().toISOString();

                localStorage.setItem('rentChecks', JSON.stringify(rentChecks));

                if (document.getElementById('rent-checks-tab').classList.contains('active')) {
                    displayRentChecks();
                }
            };

            try {
                // Step 1: Test API connection
                updateStep(0, 'running');
                const testResponse = await makeAkahuRequest('/me');
                if (!testResponse.success) {
                    updateStep(0, 'failed', `API connection failed: ${testResponse.message}`);
                    return await finalizeCheck(checkId, 'failed');
                }
                updateStep(0, 'completed', 'Successfully connected to Akahu API');

                // Step 2: Fetch accounts
                updateStep(1, 'running');
                const accountsResponse = await makeAkahuRequest('/accounts');
                if (!accountsResponse.success) {
                    updateStep(1, 'failed', `Failed to fetch accounts: ${accountsResponse.message}`);
                    return await finalizeCheck(checkId, 'failed');
                }
                updateStep(1, 'completed', `Found ${accountsResponse.items.length} accounts`);

                // Step 3: Fetch transactions
                updateStep(2, 'running');
                const allTransactions = [];
                let totalTransactions = 0;

                for (const account of accountsResponse.items) {
                    const transactionsResponse = await makeAkahuRequest(`/accounts/${account._id}/transactions?start=${getDateDaysAgo(30)}`);
                    if (transactionsResponse.success) {
                        allTransactions.push(...transactionsResponse.items);
                        totalTransactions += transactionsResponse.items.length;
                    }
                }

                if (totalTransactions === 0) {
                    updateStep(2, 'failed', 'No transactions found in the last 30 days');
                    return await finalizeCheck(checkId, 'failed');
                }
                updateStep(2, 'completed', `Retrieved ${totalTransactions} transactions from the last 30 days`);

                // Step 4: Search for keyword matches
                updateStep(3, 'running');
                const keywordMatches = allTransactions.filter(transaction => {
                    const description = (transaction.description || '').toLowerCase();
                    const keyword = property.transactionKeyword.toLowerCase();
                    return description.includes(keyword) && transaction.amount > 0;
                });

                if (keywordMatches.length === 0) {
                    updateStep(3, 'completed', `No transactions found containing "${property.transactionKeyword}"`);
                } else {
                    updateStep(3, 'completed', `Found ${keywordMatches.length} transactions containing "${property.transactionKeyword}"`);
                }

                // Step 5: Analyze payment amounts
                updateStep(4, 'running');
                const rentMatches = keywordMatches.filter(transaction => {
                    const tolerance = property.rentAmount * 0.05; // 5% tolerance
                    return Math.abs(transaction.amount - property.rentAmount) <= tolerance;
                });

                let analysisDetails;
                if (rentMatches.length === 0) {
                    analysisDetails = keywordMatches.length > 0 ?
                        `Found ${keywordMatches.length} keyword matches but none match expected rent amount ($${property.rentAmount})` :
                        'No matching payments found';
                } else {
                    const latestMatch = rentMatches.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                    analysisDetails = `Found ${rentMatches.length} matching payment(s). Latest: $${latestMatch.amount} on ${new Date(latestMatch.date).toLocaleDateString()}`;
                }

                updateStep(4, 'completed', analysisDetails);

                // Step 6: Generate report
                updateStep(5, 'running');
                await new Promise(resolve => setTimeout(resolve, 500)); // Brief pause for UX
                updateStep(5, 'completed', 'Report generated successfully');

                // Finalize the check
                await finalizeCheck(checkId, 'completed', rentMatches);

            } catch (error) {
                const check = rentChecks.find(c => c.id === checkId);
                if (check) {
                    const currentStep = check.steps.findIndex(step => step.status === 'running');
                    if (currentStep !== -1) {
                        updateStep(currentStep, 'failed', `Error: ${error.message}`);
                    }
                }
                await finalizeCheck(checkId, 'failed');
            }
        }

        async function finalizeCheck(checkId, status, matchedTransactions = []) {
            const check = rentChecks.find(c => c.id === checkId);
            if (!check) return;

            check.status = status;
            const property = properties.find(p => p.id === check.propertyId);

            if (status === 'completed' && matchedTransactions.length > 0) {
                const latestTransaction = matchedTransactions.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                const dueDate = new Date(check.lastDueDate);
                const paymentTiming = analyzePaymentTiming(latestTransaction.date, dueDate);

                check.result = {
                    paymentFound: true,
                    expectedAmount: property?.rentAmount || 0,
                    actualAmount: latestTransaction.amount,
                    transactionDate: latestTransaction.date,
                    transactionDescription: latestTransaction.description,
                    totalMatches: matchedTransactions.length,
                    rentDueDate: check.lastDueDate,
                    nextDueDate: check.nextDueDate,
                    paymentTiming: paymentTiming,
                    rentFrequency: check.rentFrequency
                };
            } else {
                check.result = {
                    paymentFound: false,
                    expectedAmount: property?.rentAmount || 0,
                    actualAmount: null,
                    transactionDate: null,
                    transactionDescription: null,
                    totalMatches: 0,
                    rentDueDate: check.lastDueDate,
                    nextDueDate: check.nextDueDate,
                    paymentTiming: null,
                    rentFrequency: check.rentFrequency
                };
            }

            localStorage.setItem('rentChecks', JSON.stringify(rentChecks));

            if (document.getElementById('rent-checks-tab').classList.contains('active')) {
                displayRentChecks();
                updateRentCheckSummary();
            }

            // Send email notification if auto-email is enabled
            if (emailSettings.enableAutoEmail && check.result) {
                const property = properties.find(p => p.id === check.propertyId);
                if (property) {
                    const emailTemplate = generateEmailTemplate(property, check.result);
                    sendEmail(emailTemplate.subject, emailTemplate.body, check.result);
                }
            }
        }

        async function simulateStep(checkId, stepIndex) {
            return new Promise(resolve => {
                setTimeout(() => {
                    const check = rentChecks.find(c => c.id === checkId);
                    if (!check) return resolve();

                    const step = check.steps[stepIndex];
                    step.status = 'running';
                    step.timestamp = new Date().toISOString();

                    localStorage.setItem('rentChecks', JSON.stringify(rentChecks));

                    if (document.getElementById('rent-checks-tab').classList.contains('active')) {
                        displayRentChecks();
                    }

                    setTimeout(() => {
                        const success = Math.random() > 0.1;
                        step.status = success ? 'completed' : 'failed';
                        step.details = success ?
                            getStepSuccessMessage(stepIndex) :
                            getStepFailureMessage(stepIndex);

                        localStorage.setItem('rentChecks', JSON.stringify(rentChecks));

                        if (document.getElementById('rent-checks-tab').classList.contains('active')) {
                            displayRentChecks();
                        }

                        resolve();
                    }, Math.random() * 2000 + 1000);
                }, 500);
            });
        }

        function getStepSuccessMessage(stepIndex) {
            const messages = [
                'Successfully connected to Akahu API',
                'Retrieved 47 transactions from the last 30 days',
                'Found 2 matching transactions',
                'Payment amount matches expected rent',
                'Report generated successfully'
            ];
            return messages[stepIndex] || 'Step completed';
        }

        function getStepFailureMessage(stepIndex) {
            const messages = [
                'API connection failed - check credentials',
                'Failed to fetch transactions - API rate limit exceeded',
                'No matching transactions found',
                'Payment amount mismatch detected',
                'Report generation failed'
            ];
            return messages[stepIndex] || 'Step failed';
        }

        function displayRentChecks() {
            const historyElement = document.getElementById('rentCheckHistory');

            if (rentChecks.length === 0) {
                historyElement.innerHTML = '<p>No rent checks have been run yet.</p>';
                return;
            }

            historyElement.innerHTML = rentChecks.map(check => `
                <div class="rent-check-item">
                    <div class="rent-check-header" onclick="toggleCheckDetails(${check.id})">
                        <div>
                            <strong>${check.propertyAddress}</strong> - ${check.tenantName}<br>
                            <small>${new Date(check.timestamp).toLocaleString()} ${check.manual ? '(Manual)' : '(Automatic)'}</small>
                        </div>
                        <span class="check-status ${check.status}">${check.status}</span>
                    </div>
                    <div id="details-${check.id}" class="rent-check-details">
                        <h4>Check Steps:</h4>
                        <ul class="step-list">
                            ${check.steps.map(step => `
                                <li class="step-item">
                                    <div class="step-icon ${step.status}">
                                        ${getStepIcon(step.status)}
                                    </div>
                                    <div class="step-content">
                                        <div class="step-title">${step.title}</div>
                                        ${step.details ? `<div class="step-details">${step.details}</div>` : ''}
                                        ${step.timestamp ? `<div class="step-details">Completed: ${new Date(step.timestamp).toLocaleTimeString()}</div>` : ''}
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                        ${check.result ? `
                            <h4>Rent Payment Report:</h4>
                            <div class="property-details">
                                <div><strong>Rent Due Date:</strong> ${new Date(check.result.rentDueDate).toLocaleDateString()}</div>
                                <div><strong>Expected Amount:</strong> $${check.result.expectedAmount} (${check.result.rentFrequency})</div>
                                <div><strong>Payment Found:</strong> <span style="color: ${check.result.paymentFound ? '#28a745' : '#dc3545'}; font-weight: bold;">${check.result.paymentFound ? 'Yes' : 'No'}</span></div>
                                ${check.result.paymentFound ? `
                                    <div><strong>Payment Date:</strong> ${new Date(check.result.transactionDate).toLocaleDateString()}</div>
                                    <div><strong>Amount Received:</strong> $${check.result.actualAmount}</div>
                                    <div><strong>Payment Status:</strong>
                                        <span style="color: ${check.result.paymentTiming.status === 'on-time' ? '#28a745' :
                                                            check.result.paymentTiming.status === 'early' ? '#007bff' : '#ffc107'}; font-weight: bold;">
                                            ${check.result.paymentTiming.description}
                                        </span>
                                    </div>
                                    <div><strong>Description:</strong> ${check.result.transactionDescription}</div>
                                    ${check.result.totalMatches > 1 ? `<div><strong>Total Matching Transactions:</strong> ${check.result.totalMatches}</div>` : ''}
                                ` : `
                                    <div style="color: #dc3545; font-style: italic; margin-top: 10px;">
                                        <strong>‚ö†Ô∏è No payment found for rent due on ${new Date(check.result.rentDueDate).toLocaleDateString()}</strong>
                                    </div>
                                `}
                                <div><strong>Next Due Date:</strong> ${new Date(check.result.nextDueDate).toLocaleDateString()}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function getStepIcon(status) {
            switch(status) {
                case 'completed': return '‚úì';
                case 'running': return '‚ü≥';
                case 'failed': return '‚úó';
                default: return '‚óè';
            }
        }

        function toggleCheckDetails(checkId) {
            const detailsElement = document.getElementById(`details-${checkId}`);
            detailsElement.classList.toggle('expanded');
        }

        function updateRentCheckSummary() {
            document.getElementById('totalChecks').textContent = rentChecks.length;
            document.getElementById('successfulChecks').textContent = rentChecks.filter(check => check.status === 'completed').length;
            document.getElementById('failedChecks').textContent = rentChecks.filter(check => check.status === 'failed').length;
            updateNextCheckDate();
        }

        async function sendEmail(subject, body, checkResult = null) {
            if (!emailSettings.enableAutoEmail || !emailSettings.notificationEmail) {
                return false;
            }

            try {
                const emailData = {
                    to: emailSettings.notificationEmail,
                    from: emailSettings.senderEmail,
                    subject: subject,
                    html: body,
                    smtpConfig: {
                        provider: emailSettings.emailProvider,
                        host: emailSettings.smtpHost,
                        port: emailSettings.smtpPort,
                        user: emailSettings.senderEmail,
                        pass: emailSettings.senderPassword
                    }
                };

                const response = await fetch('/api/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(emailData)
                });

                const result = await response.json();
                return result.success;
            } catch (error) {
                console.error('Email sending failed:', error);
                return false;
            }
        }

        function generateEmailTemplate(property, checkResult) {
            const dueDate = new Date(checkResult.rentDueDate).toLocaleDateString();
            const isPaymentFound = checkResult.paymentFound;

            let subject, body;

            if (isPaymentFound) {
                const paymentDate = new Date(checkResult.transactionDate).toLocaleDateString();
                const timingColor = checkResult.paymentTiming.status === 'on-time' ? '#28a745' :
                                   checkResult.paymentTiming.status === 'early' ? '#007bff' : '#ffc107';

                subject = `‚úÖ Rent Payment Received - ${property.address}`;
                body = `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                    <div style="background: #28a745; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
                        <h1 style="margin: 0;">‚úÖ Rent Payment Received</h1>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border: 1px solid #dee2e6; border-radius: 0 0 8px 8px;">
                        <h2 style="color: #2c3e50; margin-top: 0;">${property.address}</h2>
                        <p><strong>Tenant:</strong> ${property.tenantName}</p>

                        <div style="background: white; padding: 15px; border-radius: 4px; margin: 15px 0;">
                            <h3 style="color: #2c3e50; margin-top: 0;">Payment Details</h3>
                            <p><strong>Due Date:</strong> ${dueDate}</p>
                            <p><strong>Payment Date:</strong> ${paymentDate}</p>
                            <p><strong>Expected Amount:</strong> $${checkResult.expectedAmount}</p>
                            <p><strong>Amount Received:</strong> $${checkResult.actualAmount}</p>
                            <p><strong>Status:</strong> <span style="color: ${timingColor}; font-weight: bold;">${checkResult.paymentTiming.description}</span></p>
                            <p><strong>Description:</strong> ${checkResult.transactionDescription}</p>
                        </div>

                        <div style="background: #e8f5e8; padding: 10px; border-left: 4px solid #28a745; margin-top: 15px;">
                            <p style="margin: 0;"><strong>‚úÖ Rent payment confirmed for ${dueDate}</strong></p>
                        </div>

                        <p style="color: #666; font-size: 14px; margin-top: 20px;">
                            This is an automated notification from your Rent Property Manager.
                        </p>
                    </div>
                </div>`;
            } else {
                subject = `‚ö†Ô∏è Rent Payment Missing - ${property.address}`;
                body = `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                    <div style="background: #dc3545; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
                        <h1 style="margin: 0;">‚ö†Ô∏è Rent Payment Missing</h1>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border: 1px solid #dee2e6; border-radius: 0 0 8px 8px;">
                        <h2 style="color: #2c3e50; margin-top: 0;">${property.address}</h2>
                        <p><strong>Tenant:</strong> ${property.tenantName}</p>

                        <div style="background: white; padding: 15px; border-radius: 4px; margin: 15px 0;">
                            <h3 style="color: #2c3e50; margin-top: 0;">Payment Details</h3>
                            <p><strong>Due Date:</strong> ${dueDate}</p>
                            <p><strong>Expected Amount:</strong> $${checkResult.expectedAmount} (${checkResult.rentFrequency})</p>
                            <p><strong>Search Keyword:</strong> "${property.transactionKeyword}"</p>
                        </div>

                        <div style="background: #f8d7da; padding: 10px; border-left: 4px solid #dc3545; margin-top: 15px;">
                            <p style="margin: 0;"><strong>‚ùå No payment found for rent due on ${dueDate}</strong></p>
                        </div>

                        <p style="margin-top: 15px;">
                            <strong>Next Due Date:</strong> ${new Date(checkResult.nextDueDate).toLocaleDateString()}
                        </p>

                        <p style="color: #666; font-size: 14px; margin-top: 20px;">
                            This is an automated notification from your Rent Property Manager.
                            Please check your bank account or contact your tenant.
                        </p>
                    </div>
                </div>`;
            }

            return { subject, body };
        }

        async function testEmail() {
            // Enhanced validation
            if (!emailSettings.notificationEmail || !emailSettings.senderEmail) {
                showStatus('emailStatus', 'Please configure email settings first', 'error');
                return;
            }

            if (!emailSettings.emailProvider) {
                showStatus('emailStatus', 'Please select an email service provider', 'error');
                return;
            }

            if (!emailSettings.senderPassword) {
                showStatus('emailStatus', 'Please enter your email password/app password', 'error');
                return;
            }

            if (emailSettings.emailProvider === 'smtp' && (!emailSettings.smtpHost || !emailSettings.smtpPort)) {
                showStatus('emailStatus', 'Please configure SMTP host and port for custom SMTP', 'error');
                return;
            }

            console.log('Testing email with settings:', {
                to: emailSettings.notificationEmail,
                from: emailSettings.senderEmail,
                provider: emailSettings.emailProvider,
                host: emailSettings.smtpHost,
                port: emailSettings.smtpPort
            });

            const testEmailTemplate = {
                subject: 'Test Email - Rent Property Manager',
                body: `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                    <div style="background: #3498db; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
                        <h1 style="margin: 0;">üìß Test Email</h1>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border: 1px solid #dee2e6; border-radius: 0 0 8px 8px;">
                        <h2 style="color: #2c3e50; margin-top: 0;">Email Configuration Test</h2>
                        <p>This is a test email from your Rent Property Manager system.</p>
                        <p>If you receive this email, your email configuration is working correctly!</p>
                        <div style="background: #d4edda; padding: 10px; border-left: 4px solid #28a745; margin-top: 15px;">
                            <p style="margin: 0;"><strong>‚úÖ Email system is functioning properly</strong></p>
                        </div>
                        <p style="color: #666; font-size: 14px; margin-top: 20px;">
                            Test sent at: ${new Date().toLocaleString()}
                        </p>
                    </div>
                </div>`
            };

            showStatus('emailStatus', 'Sending test email...', 'success');

            try {
                const response = await fetch('/api/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: emailSettings.notificationEmail,
                        from: emailSettings.senderEmail,
                        subject: testEmailTemplate.subject,
                        html: testEmailTemplate.body,
                        smtpConfig: {
                            provider: emailSettings.emailProvider,
                            host: emailSettings.smtpHost,
                            port: emailSettings.smtpPort,
                            user: emailSettings.senderEmail,
                            pass: emailSettings.senderPassword
                        }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('emailStatus', 'Test email sent successfully! Check your inbox.', 'success');
                } else {
                    let errorMsg = `Test email failed: ${result.error}`;
                    if (result.hint) {
                        errorMsg += ` | Hint: ${result.hint}`;
                    }
                    if (result.details) {
                        errorMsg += ` | Details: ${result.details}`;
                    }
                    console.error('Email test failed:', result);
                    showStatus('emailStatus', errorMsg, 'error');
                }
            } catch (error) {
                showStatus('emailStatus', `Test email failed: ${error.message}`, 'error');
            }
        }

        async function checkEmailConfig() {
            // Enhanced validation (same as testEmail)
            if (!emailSettings.notificationEmail || !emailSettings.senderEmail) {
                showStatus('emailStatus', 'Please configure email settings first', 'error');
                return;
            }

            if (!emailSettings.emailProvider) {
                showStatus('emailStatus', 'Please select an email service provider', 'error');
                return;
            }

            if (!emailSettings.senderPassword) {
                showStatus('emailStatus', 'Please enter your email password/app password', 'error');
                return;
            }

            if (emailSettings.emailProvider === 'smtp' && (!emailSettings.smtpHost || !emailSettings.smtpPort)) {
                showStatus('emailStatus', 'Please configure SMTP host and port for custom SMTP', 'error');
                return;
            }

            showStatus('emailStatus', 'Checking email configuration...', 'success');

            try {
                const response = await fetch('/api/check-email-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        smtpConfig: {
                            provider: emailSettings.emailProvider,
                            host: emailSettings.smtpHost,
                            port: emailSettings.smtpPort,
                            user: emailSettings.senderEmail,
                            pass: emailSettings.senderPassword
                        }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('emailStatus', '‚úÖ Email configuration is valid! You can now send test emails.', 'success');
                } else {
                    let errorMsg = `‚ùå Configuration check failed: ${result.error}`;
                    if (result.hint) {
                        errorMsg += ` | Hint: ${result.hint}`;
                    }
                    if (result.details) {
                        errorMsg += ` | Details: ${result.details}`;
                    }
                    console.error('Email configuration check failed:', result);
                    showStatus('emailStatus', errorMsg, 'error');
                }
            } catch (error) {
                showStatus('emailStatus', `Configuration check failed: ${error.message}`, 'error');
            }
        }

        function startAutoCheck() {
            if (checkInterval) clearInterval(checkInterval);

            // Check every 10 minutes (600,000 ms) instead of every minute for better performance
            checkInterval = setInterval(() => {
                runRentCheck(false);
            }, 600000);
        }

        function loadSavedData() {
            if (akahuSettings.appToken) {
                document.getElementById('akahuAppToken').value = akahuSettings.appToken;
            }
            if (akahuSettings.userToken) {
                document.getElementById('akahuUserToken').value = akahuSettings.userToken;
            }

            // Load email settings
            if (emailSettings.notificationEmail) {
                document.getElementById('notificationEmail').value = emailSettings.notificationEmail;
            }
            if (emailSettings.emailProvider) {
                document.getElementById('emailProvider').value = emailSettings.emailProvider;
                // Trigger change event to set SMTP settings
                document.getElementById('emailProvider').dispatchEvent(new Event('change'));
            }
            if (emailSettings.senderEmail) {
                document.getElementById('senderEmail').value = emailSettings.senderEmail;
            }
            if (emailSettings.senderPassword) {
                document.getElementById('senderPassword').value = emailSettings.senderPassword;
            }
            if (emailSettings.smtpHost) {
                document.getElementById('smtpHost').value = emailSettings.smtpHost;
            }
            if (emailSettings.smtpPort) {
                document.getElementById('smtpPort').value = emailSettings.smtpPort;
            }
            if (emailSettings.enableAutoEmail) {
                document.getElementById('enableAutoEmail').checked = emailSettings.enableAutoEmail;
            }

            displayProperties();
            updateRentCheckSummary();
            startAutoCheck();
        }

        loadSavedData();
    </script>
</body>
</html>